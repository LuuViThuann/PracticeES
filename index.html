<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LVT - Practice Listening to English</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" type="image/png" href="https://images.vexels.com/media/users/3/150845/isolated/preview/333bdf231eba2185ef3e211bb541c09f-audio-headphones-icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans text-gray-800">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 shadow-lg">
        <div class="flex flex-col sm:flex-row items-center justify-center text-center gap-3 px-4">
          <img src="assets/image/dnc.jpg" 
               alt="logo" 
               class="w-12 sm:w-14 rounded-full object-cover">
          <h1 class="text-2xl sm:text-3xl font-bold leading-snug">
            Practice Listening to English
          </h1>
          <a href="#" id="startTestBtn" class="ml-0 sm:ml-4 bg-green-600 test-btn text-white px-4 py-2 rounded-lg font-semibold shadow-md flex items-center relative overflow-hidden">
            <i class="fas fa-clipboard-check mr-2"></i>Thi thử ngay nào !
          </a>
        </div>
      </header>
      <div class="marquee-container">
        <span class="marquee-text">
            Hãy sử dụng LAPTOP để dễ quan sát hơn nhé ! Nếu có bất kì sai sót hoặc lỗi nào nhắn mình khắc phục nhé , cùng nhau cố gắng đạt điểm cao nhất nhé hihi !
        </span>
      </div>
  
  <div class="container max-w-7xl mx-auto p-6">
    <!-- Trang danh sách -->
    <div id="lessonList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <!-- Trang chi tiết -->
    <div id="lessonPage" class="hidden bg-white rounded-2xl p-6 shadow-xl">
      <div id="subtitleDisplay" class="mt-6 hidden p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Phụ đề:</h3>
        <pre id="subtitleText" class="text-sm text-gray-600 whitespace-pre-wrap overflow-auto max-h-60"></pre>
      </div>
      <div class="flex flex-col lg:flex-row gap-6">
        <div class="lg:w-2/3">
          <h2 id="lessonTitle" class="text-2xl font-semibold text-blue-600 mb-4"></h2>
          <div id="lessonImages" class="grid grid-cols-1 gap-4"></div>
        </div>
        <div class="lg:w-1/3">
          <div class="flex items-center mb-4">
            <i class="fas fa-headphones text-blue-600 text-2xl mr-2"></i>
            <audio id="lessonAudio" controls class="w-full"></audio>
          </div>
          <div id="subtitleToggle" class="mb-4 hidden">
            <button id="toggleSubtitles" onclick="toggleSubtitles()" class="control-btn subtitle-btn text-white px-6 py-3 rounded-lg font-semibold shadow-md w-full bg-green-600 hover:bg-green-700">
              <i class="fas fa-closed-captioning mr-2"></i>Xem phụ đề
            </button>
          </div>
          <div id="answerInputs" class="space-y-4"></div>
          <div class="controls flex flex-col sm:flex-row gap-4 mt-6">
            <button onclick="checkAnswer()" class="control-btn check-btn text-white px-6 py-3 rounded-lg font-semibold shadow-md w-full sm:w-auto bg-blue-600 hover:bg-blue-700">Kiểm tra</button>
            <button onclick="resetAnswer()" class="control-btn reset-btn text-white px-6 py-3 rounded-lg font-semibold shadow-md w-full sm:w-auto bg-gray-600 hover:bg-gray-700">Làm lại</button>
            <button onclick="goBack()" class="control-btn back-btn text-gray-800 px-6 py-3 rounded-lg font-semibold shadow-md w-full sm:w-auto bg-gray-200 hover:bg-gray-300">Quay lại</button>
          </div>
          
          <div id="result" class="mt-6 p-4 rounded-lg"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-4 text-gray-600">
    <p>© 2025 Practice Listening to English - Thuận phần mềm - DNC</p>
  </footer>

 

  <script>
   

    let lessons = [];
    let currentLesson = null;
    let isShowingSubtitles = false;

    const lessonList = document.getElementById("lessonList");
    const lessonPage = document.getElementById("lessonPage");
    const lessonTitle = document.getElementById("lessonTitle");
    const lessonImages = document.getElementById("lessonImages");
    const lessonAudio = document.getElementById("lessonAudio");
    const answerInputs = document.getElementById("answerInputs");
    const result = document.getElementById("result");
    const subtitleToggle = document.getElementById("subtitleToggle");
    const subtitleDisplay = document.getElementById("subtitleDisplay");
    const subtitleText = document.getElementById("subtitleText");
    const toggleSubtitlesBtn = document.getElementById("toggleSubtitles");
    const startTestBtn = document.getElementById("startTestBtn");

    // Load dữ liệu từ lessons.json
    fetch("assets/js/lessons.json")
      .then(res => res.json())
      .then(data => {
        lessons = data;
        renderLessonList();
      })
      .catch(err => console.error("Lỗi tải lessons.json:", err));

    function renderLessonList() {
      lessonList.innerHTML = "";
      lessons.forEach((lesson, index) => {
        const div = document.createElement("div");
        div.className = "lesson-card bg-white rounded-xl p-5 shadow-md cursor-pointer";
        div.innerHTML = `
            <h3 class="text-lg font-semibold text-blue-600">${lesson.title}</h3>
            <i class="fas fa-headphones headphone-icon"></i>
        `;
        div.onclick = () => openLesson(index);
        lessonList.appendChild(div);
      });
    }

    function openLesson(index) {
      currentLesson = lessons[index];
      lessonList.classList.add("hidden");
      lessonPage.classList.remove("hidden");

      document.querySelectorAll('.lesson-card').forEach(card => card.classList.remove('selected'));
      document.querySelectorAll('.lesson-card')[index].classList.add('selected');

      lessonTitle.textContent = currentLesson.title;
      lessonAudio.src = currentLesson.audio;
      result.textContent = "";
      result.className = "mt-6 p-4 rounded-lg";

      // Reset subtitle state
      isShowingSubtitles = false;
      subtitleToggle.classList.add("hidden");
      subtitleDisplay.classList.add("hidden");
      toggleSubtitlesBtn.innerHTML = '<i class="fas fa-closed-captioning mr-2"></i>Xem phụ đề';

      // Render images
      lessonImages.innerHTML = "";
      const images = Array.isArray(currentLesson.image) ? currentLesson.image : [currentLesson.image];
      images.forEach(imageSrc => {
        const img = document.createElement("img");
        img.src = imageSrc;
        img.alt = currentLesson.title;
        img.className = "w-full rounded-lg mb-4";
        lessonImages.appendChild(img);
      });

      // Render inputs
      answerInputs.innerHTML = "";
      if (currentLesson.questions) {
        currentLesson.questions.forEach((question, qIndex) => {
          const questionDiv = document.createElement("div");
          questionDiv.className = "mb-6";
          const questionTitle = document.createElement("h3");
          questionTitle.className = "text-lg font-semibold text-gray-700 mb-2";
          questionTitle.textContent = question.title;
          questionDiv.appendChild(questionTitle);
          if (question.type === "checkbox") {
            const div = document.createElement("div");
            div.className = "space-y-2";
            question.options.forEach(option => {
              const label = document.createElement("label");
              label.className = "flex items-center space-x-2";
              const input = document.createElement("input");
              input.type = "checkbox";
              input.className = "answer-checkbox h-5 w-5 text-blue-600";
              input.value = option.value;
              input.dataset.correct = option.correct;
              label.appendChild(input);
              label.appendChild(document.createTextNode(` ${option.label}`));
              div.appendChild(label);
            });
            questionDiv.appendChild(div);
          } else if (question.type === "text") {
            const answers = question.answers || question.answer || [];
            answers.forEach((answer, i) => {
              const input = document.createElement("input");
              input.type = "text";
              input.className = "answer-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500";
              input.placeholder = `Nhập câu trả lời câu ${i + 1}...`;
              input.dataset.correct = answer;
              questionDiv.appendChild(input);
            });
          }
          answerInputs.appendChild(questionDiv);
        });
      } else if (currentLesson.answer) {
        const isCheckboxFormat = Array.isArray(currentLesson.answer) && currentLesson.answer.some(a => a.includes(":check"));
        if (isCheckboxFormat) {
          const div = document.createElement("div");
          div.className = "space-y-2";
          const options = ["A", "B", "C", "D", "E"];
          options.forEach(option => {
            if (currentLesson.answer.some(a => a.startsWith(option + ":check"))) {
              const label = document.createElement("label");
              label.className = "flex items-center space-x-2";
              const input = document.createElement("input");
              input.type = "checkbox";
              input.className = "answer-checkbox h-5 w-5 text-blue-600";
              input.value = option;
              input.dataset.correct = currentLesson.answer.find(a => a.startsWith(option + ":check")).includes(":right");
              label.appendChild(input);
              label.appendChild(document.createTextNode(` ${option}`));
              div.appendChild(label);
            }
          });
          answerInputs.appendChild(div);
          const textAnswers = currentLesson.answer.filter(a => !a.includes(":check"));
          textAnswers.forEach((answer, i) => {
            const input = document.createElement("input");
            input.type = "text";
            input.className = "answer-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500";
            input.placeholder = `Nhập câu trả lời câu ${i + 1}...`;
            input.dataset.correct = answer;
            answerInputs.appendChild(input);
          });
        } else {
          const answers = Array.isArray(currentLesson.answer) ? currentLesson.answer : [currentLesson.answer];
          answers.forEach((answer, i) => {
            const input = document.createElement("input");
            input.type = "text";
            input.className = "answer-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500";
            input.placeholder = `Nhập câu trả lời câu ${i + 1}...`;
            input.dataset.correct = answer;
            answerInputs.appendChild(input);
          });
        }
      }

      // Check for subtitles
      if (currentLesson.subtitles) {
        subtitleToggle.classList.remove("hidden");
      }
    }

    function toggleSubtitles() {
      isShowingSubtitles = !isShowingSubtitles;
      if (isShowingSubtitles) {
        loadSubtitles();
        subtitleDisplay.classList.remove("hidden");
        toggleSubtitlesBtn.innerHTML = '<i class="fas fa-closed-captioning mr-2"></i>Ẩn phụ đề';
        Swal.fire({
          title: 'Phụ đề đã được bật !',
          text: 'Bạn có thể xem phụ đề cho bài học này bên trên.',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
      } else {
        subtitleDisplay.classList.add("hidden");
        toggleSubtitlesBtn.innerHTML = '<i class="fas fa-closed-captioning mr-2"></i>Xem phụ đề';
      }
    }

    function loadSubtitles() {
      if (!currentLesson.subtitles) return;
      fetch(currentLesson.subtitles)
        .then(res => res.text())
        .then(data => {
          subtitleText.textContent = data;
        })
        .catch(err => {
          console.error("Lỗi tải phụ đề:", err);
          subtitleText.textContent = "Không thể tải phụ đề.";
          Swal.fire({
            title: 'Lỗi!',
            text: 'Không thể tải phụ đề.',
            icon: 'error',
            timer: 2000,
            showConfirmButton: false
          });
        });
    }

    function checkAnswer() {
      let userAnswers = [];
      let correctAnswers = [];
      if (currentLesson.questions) {
        currentLesson.questions.forEach((question, qIndex) => {
          const questionDiv = answerInputs.children[qIndex];
          if (question.type === "checkbox") {
            const checkboxes = questionDiv.querySelectorAll(`.answer-checkbox:checked`);
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const correct = question.options.filter(opt => opt.correct).map(opt => opt.value);
            userAnswers.push(...selected);
            correctAnswers.push(...correct);
          } else if (question.type === "text") {
            const inputs = questionDiv.querySelectorAll(".answer-input");
            const answers = question.answers || question.answer || [];
            const userTextAnswers = Array.from(inputs).map(i => i.value.trim().toLowerCase() || "");
            userAnswers.push(...userTextAnswers);
            correctAnswers.push(...answers.map(a => a.toLowerCase()));
          }
        });
      } else if (currentLesson.answer) {
        const isCheckboxFormat = Array.isArray(currentLesson.answer) && currentLesson.answer.some(a => a.includes(":check"));
        if (isCheckboxFormat) {
          const checkboxes = answerInputs.querySelectorAll(".answer-checkbox:checked");
          userAnswers = Array.from(checkboxes).map(cb => cb.value);
          correctAnswers = currentLesson.answer
            .filter(a => a.includes(":check:right"))
            .map(a => a.split(":")[0]);
          const textInputs = answerInputs.querySelectorAll(".answer-input");
          const textUserAnswers = Array.from(textInputs).map(i => i.value.trim().toLowerCase() || "");
          userAnswers = userAnswers.concat(textUserAnswers);
          const textCorrectAnswers = currentLesson.answer
            .filter(a => !a.includes(":check"))
            .map(a => a.toLowerCase());
          correctAnswers = correctAnswers.concat(textCorrectAnswers);
        } else {
          const inputs = answerInputs.querySelectorAll(".answer-input");
          userAnswers = Array.from(inputs).map(i => i.value.trim().toLowerCase() || "");
          correctAnswers = Array.isArray(currentLesson.answer)
            ? currentLesson.answer.map(a => a.toLowerCase())
            : [currentLesson.answer.toLowerCase()];
        }
      }
      const correct = userAnswers.length === correctAnswers.length &&
        userAnswers.every((ua, i) => ua === correctAnswers[i]);
      const userAnswersList = userAnswers.map((ans, i) => `<li class="text-sm sm:text-base">Câu ${i + 1}: ${ans || 'Chưa nhập'}</li>`).join("");
      const correctAnswersList = correctAnswers.map((ans, i) => `<li class="text-sm sm:text-base">Câu ${i + 1}: ${ans}</li>`).join("");
      if (correct) {
        result.innerHTML = `
          <div class="bg-green-100 text-green-800 p-4 sm:p-6 rounded-lg animate-result-correct">
            <p class="text-lg sm:text-xl font-semibold">✅ Chính xác!</p>
            <p class="font-semibold mt-2">Đáp án của bạn:</p>
            <ul class="list-disc list-inside text-sm sm:text-base">${userAnswersList}</ul>
            <p class="font-semibold mt-2">Đáp án đúng:</p>
            <ul class="list-disc list-inside text-sm sm:text-base">${correctAnswersList}</ul>
          </div>
        `;
      } else {
        result.innerHTML = `
          <div class="bg-red-100 text-red-800 p-4 sm:p-6 rounded-lg animate-result-wrong">
            <p class="text-lg sm:text-xl font-semibold">❌ Sai rồi, thử lại nhé!</p>
            <p class="font-semibold mt-2">Đáp án của bạn:</p>
            <ul class="list-disc list-inside text-sm sm:text-base">${userAnswersList}</ul>
            <p class="font-semibold mt-2">Đáp án đúng:</p>
            <ul class="list-disc list-inside text-sm sm:text-base">${correctAnswersList}</ul>
          </div>
        `;
      }
    }

    function resetAnswer() {
      const inputs = answerInputs.querySelectorAll(".answer-input");
      inputs.forEach(input => input.value = "");
      const checkboxes = answerInputs.querySelectorAll(".answer-checkbox");
      checkboxes.forEach(cb => cb.checked = false);
      result.textContent = "";
      result.className = "mt-6 p-4 rounded-lg";
    }

    function goBack() {
      lessonPage.classList.add("hidden");
      lessonList.classList.remove("hidden");
    }

    startTestBtn.addEventListener("click", function(e) {
      e.preventDefault();
      Swal.fire({
        title: 'Bắt đầu thi thử?',
        text: 'Chế độ thi thử sẽ hiển thị 5 bài ngẫu nhiên và hoàn thành trong 25 phút. Bạn có muốn bắt đầu ngay?',
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Bắt đầu',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#16a34a',
        cancelButtonColor: '#d1d5db'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = "test.html";
        }
      });
    });

    (function lockDevTools() {
      document.addEventListener('contextmenu', function(e) { e.preventDefault(); });
      document.addEventListener('selectstart', function(e) { e.preventDefault(); });
      document.addEventListener('copy', function(e) { e.preventDefault(); });
      document.addEventListener('keydown', function(e) {
        const key = e.key || e.keyCode;
        if (e.key === 'F12' || key === 123) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
        if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
        if (e.ctrlKey && (e.key === 'U' || e.key === 'u' || key === 85)) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
        if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
      let devtoolsOpen = false;
      const threshold = 160;
      setInterval(function() {
        const widthThreshold = window.outerWidth - window.innerWidth > threshold;
        const heightThreshold = window.outerHeight - window.innerHeight > threshold;
        if ((widthThreshold || heightThreshold) && !devtoolsOpen) {
          devtoolsOpen = true;
          console.clear();
          console.log("DevTools detected - nội dung bị hạn chế.");
        } else if (!(widthThreshold || heightThreshold) && devtoolsOpen) {
          devtoolsOpen = false;
        }
      }, 1000);
    })();
  </script>